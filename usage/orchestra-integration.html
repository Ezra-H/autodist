

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Orchestra Integration &mdash; AutoDist  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/customized.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Runner" href="../api/autodist.runner.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> AutoDist
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorials/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/multi-node.html">Train on Multiple Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/save-restore.html">Save and Restore Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/docker.html">Train with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/choose-strategy.html">Choose Strategy Builders</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/customize-strategy.html">Customize a Strategy Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../design/rationale.html">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/kernels.html">Graph Transformation Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/autodist.html">Developer API References</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.checkpoint.html">Checkpoint</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.checkpoint.saved_model_builder.html">Saved Model Builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.checkpoint.saver.html">Saver</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.kernel.html">Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.common.html">Common</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.common.op_info.html">Op Info</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.common.proxy_variable.html">Proxy Variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.common.utils.html">Utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.common.variable_utils.html">Variable Utils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.device.html">Device</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.device.resolver.html">Resolver</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.synchronization.html">Synchronization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.synchronization.all_reduce_synchronizer.html">All Reduce Synchronizer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.synchronization.collective_key.html">Collective Key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.synchronization.compressor.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.synchronization.ps_synchronizer.html">Ps Synchronizer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/autodist.kernel.synchronization.synchronizer.html">Synchronizer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.graph_transformer.html">Graph Transformer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.kernel.html">Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.partitioner.html">Partitioner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.kernel.replicator.html">Replicator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.proto.html">Proto</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.proto.graphitem_pb2.html">Graphitem Pb2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.proto.strategy_pb2.html">Strategy Pb2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.proto.synchronizers_pb2.html">Synchronizers Pb2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.strategy.html">Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.all_reduce_strategy.html">All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.base.html">Base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.parallax_strategy.html">Parallax Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.partitioned_all_reduce_strategy.html">Partitioned All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.partitioned_ps_strategy.html">Partitioned Ps Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.ps_lb_strategy.html">Ps Lb Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.ps_strategy.html">Ps Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.random_axis_partition_all_reduce_strategy.html">Random Axis Partition All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.strategy.uneven_partition_ps_strategy.html">Uneven Partition Ps Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.utils.html">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.utils.logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.utils.network.html">Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.utils.server_starter.html">Server Starter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/autodist.utils.visualization_util.html">Visualization Util</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.autodist.html">Autodist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.cluster.html">Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.const.html">Const</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.coordinator.html">Coordinator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.graph_item.html">Graph Item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.patch.html">Patch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.remapper.html">Remapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.resource_spec.html">Resource Spec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/autodist.runner.html">Runner</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Orchestra Integration</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AutoDist</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Orchestra Integration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usage/orchestra-integration.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="orchestra-integration">
<h1>Orchestra Integration<a class="headerlink" href="#orchestra-integration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-orchestra">
<h2>What is Orchestra?<a class="headerlink" href="#what-is-orchestra" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://petuum.com/platform/">Orchestra</a> is a machine learning platform built by Petuum Inc. which includes data management, job control, etc. AutoDist will be the distributed training backend of this platform.</p>
</div>
<div class="section" id="autodist-in-orchestra">
<h2>AutoDist in Orchestra<a class="headerlink" href="#autodist-in-orchestra" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-directory-path">
<h3>Data Directory Path<a class="headerlink" href="#data-directory-path" title="Permalink to this headline">¶</a></h3>
<p>In Orchestra, data will be managed automatically, and sometimes AutoDist users can not get the data path until the runtime. In this case, Orchestra will provide the data directory path through an environment variable <code class="docutils literal notranslate"><span class="pre">SYS_DATA_PATH</span></code> to all AutoDist worker nodes. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SYS_DATA_PATH&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="resource-file-path">
<h3>Resource File Path<a class="headerlink" href="#resource-file-path" title="Permalink to this headline">¶</a></h3>
<p>Orchestra is built on virtualization techniques, so there is no static network configuration for AutoDist. To match the current AutoDist coordination mechanism, Orchestra will generate a temporary resource spec used by AutoDist, which the file path is also given by an environment path <code class="docutils literal notranslate"><span class="pre">SYS_RESOURCE_PATH</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resource_spec_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SYS_RESOURCE_PATH&quot;</span><span class="p">)</span>
<span class="n">autodist</span> <span class="o">=</span> <span class="n">AutoDist</span><span class="p">(</span><span class="n">resource_spec_file</span><span class="p">,</span> <span class="n">AllReduce</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-code">
<h2>Example Code<a class="headerlink" href="#example-code" title="Permalink to this headline">¶</a></h2>
<p>This is an example AutoDist code that can be executed on Orchestra.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">autodist</span> <span class="kn">import</span> <span class="n">AutoDist</span>
<span class="kn">from</span> <span class="nn">autodist.strategy.all_reduce_strategy</span> <span class="kn">import</span> <span class="n">AllReduce</span>

<span class="c1"># A customized loader provided by user</span>
<span class="kn">from</span> <span class="nn">data_loader</span> <span class="kn">import</span> <span class="n">load_data</span>

<span class="n">resource_spec_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SYS_RESOURCE_PATH&quot;</span><span class="p">)</span>
<span class="n">autodist_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SYS_DATA_PATH&quot;</span><span class="p">)</span>

<span class="n">TRUE_W</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">TRUE_b</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">NUM_EXAMPLES</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">autodist_data_path</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">inputs</span> <span class="o">*</span> <span class="n">TRUE_W</span> <span class="o">+</span> <span class="n">TRUE_b</span> <span class="o">+</span> <span class="n">noises</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Train the model and save the serialized model and its weights.&quot;&quot;&quot;</span>
    <span class="n">autodist</span> <span class="o">=</span> <span class="n">AutoDist</span><span class="p">(</span><span class="n">resource_spec_file</span><span class="p">,</span> <span class="n">AllReduce</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">autodist</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">NUM_EXAMPLES</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>    <span class="c1"># nopep8</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">y</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">W</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>

        <span class="k">def</span> <span class="nf">loss_func</span><span class="p">(</span><span class="n">predicted_y</span><span class="p">,</span> <span class="n">desired_y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">predicted_y</span> <span class="o">-</span> <span class="n">desired_y</span><span class="p">))</span>

        <span class="n">major_version</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">VERSION</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">major_version</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">():</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">y</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">W</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
            <span class="n">train_op</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">vs</span><span class="p">))</span>

        <span class="n">fetches</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss</span><span class="p">,</span> <span class="n">train_op</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">prediction</span><span class="p">]</span>
        <span class="n">feeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">autodist</span><span class="o">.</span><span class="n">create_distributed_session</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
            <span class="n">train_loss</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fetches</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">feeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">inputs</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../api/autodist.runner.html" class="btn btn-neutral float-left" title="Runner" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Petuum

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>